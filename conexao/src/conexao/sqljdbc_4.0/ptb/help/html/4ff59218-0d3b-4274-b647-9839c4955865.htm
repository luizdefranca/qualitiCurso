<html xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:mshelp="http://msdn.microsoft.com/mshelp" xmlns:ddue="http://ddue.schemas.microsoft.com/authoring/2003/5" xmlns:msxsl="urn:schemas-microsoft-com:xslt"><head><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8" /><META NAME="save" CONTENT="history" /><title>Usando o espelhamento de banco de dados (JDBC)</title><meta name="Language" content="pt-br" /><meta name="System.Keywords" content="espelhamento" /><meta name="Microsoft.Help.Id" content="4ff59218-0d3b-4274-b647-9839c4955865" /><meta name="Description" content="O espelhamento de banco de dados é uma solução de software destinada principalmente a aumentar a disponibilidade do banco de dados e a redundância dos dados." /><meta name="Microsoft.Help.ContentType" content="Concepts" /><link rel="stylesheet" type="text/css" href="../local/Classic.css" /><script type="text/javascript" src="../scripts/EventUtilities.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/SplitScreen.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/Dropdown.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/script_manifold.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/script_feedBack.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/CheckboxMenu.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/CommonUtilities.js">&amp;nbsp;</script><script type="text/javascript" src="../local/script_main.js">&amp;nbsp;</script></head><body><div id="header"><table id="bottomTable" cellpadding="0" cellspacing="0"><tr><td align="left"><span id="headerBold">Usando o espelhamento de banco de dados (JDBC)</span></td></tr></table><table id="gradientTable"><tr><td class="nsrBottom" background="../icons/gradient.gif" /></tr></table></div><div id="mainSection"><div id="mainBody"><div class="introduction"><p>O espelhamento de banco de dados é uma solução de software destinada principalmente a aumentar a disponibilidade do banco de dados e a redundância dos dados. O Microsoft JDBC Driver para SQL Server fornece suporte implícito ao espelhamento de banco de dados, de forma que, depois que ele é configurado para o banco de dados, o desenvolvedor não precisa escrever nenhum código nem executar qualquer outra ação.</p><p>O espelhamento de banco de dados, que é implementado para cada banco de dados, mantém uma cópia de um banco de dados de produção do SQL Server em um servidor em espera. Trata-se de um servidor em espera ativa ou passiva, dependendo da configuração e do estado da sessão de espelhamento de banco de dados. Um servidor em espera ativa dá suporte a um failover rápido sem perda de transações confirmadas, e um servidor em espera passiva dá suporte ao serviço de imposição (com possível perda de dados).</p><p>O banco de dados de produção é chamado de banco de dados <span class="term">principal</span>, e a cópia em espera é chamada de banco de dados <span class="term">espelho</span>. O banco de dados principal e o banco de dados espelho devem residir em instâncias separadas do SQL Server (instâncias do servidor) e, se possível, em computadores separados.</p><p>A instância do servidor de produção, chamada de servidor principal, se comunica com a instância do servidor em espera, chamada de servidor espelho. Os servidores principal e espelho atuam como parceiros em uma sessão de espelhamento de banco de dados. Se o servidor principal falhar, o servidor espelho poderá transformar seu banco de dados no banco de dados principal por meio de um processo chamado <span class="term">failover</span>. Por exemplo, Parceiro_A e Parceiro_B são dois servidores parceiros, com o banco de dados principal inicialmente no Parceiro_A como o servidor principal e o banco de dados espelho residindo no Parceiro_B como o servidor espelho. Se o Parceiro_A ficar offline, o banco de dados no Parceiro_B poderá fazer failover para se tornar o banco de dados principal atual. Quando o Parceiro_A ingressar novamente na sessão de espelhamento, ele se tornará o servidor espelho e seu banco de dados se tornará o banco de dados espelho.</p><p>Caso o servidor do Parceiro_A seja danificado de forma irreparável, um servidor do Parceiro_C poderá ser colocado online para agir como o servidor espelho do Parceiro_B, que passa a ser o servidor principal. Porém, nesse cenário, o aplicativo cliente deverá incluir lógica de programação para assegurar que as propriedades de cadeia de conexão sejam atualizadas com os novos nomes de servidor usados na configuração de espelhamento de banco de dados. Caso contrário, poderá ocorrer falha na conexão com os servidores.</p><p>Configurações alternativas de espelhamento de banco de dados oferecem diferentes níveis de desempenho e segurança de dados, além de dar suporte a diferentes formas de failover. Para obter mais informações, consulte "Visão geral do espelhamento de banco de dados" nos Manuais Online do SQL Server.</p></div><h1 class="heading">Considerações sobre programação</h1><div id="sectionSection0" class="section" name="collapseableSection" style=""><p>Quando ocorre falha no servidor do banco de dados principal, o aplicativo cliente recebe erros em resposta a chamadas à API, o que indica que a conexão com o banco de dados foi interrompida. Quando isso acontece, todas as alterações não confirmadas feitas no banco de dados são perdidas e a transação atual é revertida. Nesse caso, o aplicativo deve fechar a conexão (ou liberar o objeto de fonte de dados) e tentar reabri-la. Ao ser estabelecida, a nova conexão é redirigida, de forma transparente, ao banco de dados espelho, que agora age como o servidor principal, sem que o cliente precise modificar a cadeia de conexão ou o objeto de fonte de dados.</p><p>Quando uma conexão é estabelecida inicialmente, o servidor principal envia a identidade de seu parceiro de failover ao cliente que será usado quando ocorrer um failover. Quando um aplicativo tenta estabelecer uma conexão inicial com um servidor principal falho, o cliente não sabe a identidade do parceiro de failover. Para que os clientes tenham a oportunidade de lidar com esse cenário, a propriedade de cadeia de conexão failoverPartner e, opcionalmente, o método de fonte de dados <a href="5310b7c2-9d10-474f-ad3a-218fe5da694b.htm">setFailoverPartner</a> permitem ao cliente especificar a identidade do parceiro de failover por sua própria conta. A propriedade do cliente é usada apenas nesse cenário; se o servidor principal estiver disponível, ela não será usada. </p><div style="margin: .5em 1.5em .5em 1.5em"><b></b><p>Quando uma propriedade failoverPartner é especificada na cadeia de conexão ou com um objeto de fonte de dados, a propriedade databaseName também deve ser definida; caso contrário, uma exceção será lançada. Se as propriedades failoverPartner e databaseName não forem especificadas explicitamente, o aplicativo não tentará fazer failover quando ocorrer falha no servidor de banco de dados principal. Em outras palavras, o redirecionamento transparente só funcionará para conexões que especifiquem explicitamente failoverPartner e databaseName. Para obter mais informações sobre failoverPartner e outras propriedades de cadeia de conexão, consulte <span sdata="link"><a href="f1b62700-f046-488d-bd6b-a5cd8fc345b7.htm">Definindo as propriedades de conexão</a></span>.</p></div><p>Se o servidor do parceiro de failover fornecido pelo cliente não se referir a um servidor que funciona como um parceiro de failover para o banco de dados especificado, e se o servidor/banco de dados referenciado estiver em uma disposição de espelhamento, a conexão será recusada pelo servidor. Embora a classe <a href="097434fd-2b74-411c-a5ed-eba04481dde5.htm">SQLServerDataSource</a> forneça o método <a href="885f927f-9c48-42e0-a7fb-fd936d2b8130.htm">getFailoverPartner</a>, esse método só retorna o nome do parceiro de failover especificado na cadeia de conexão ou no método <b>setFailoverPartner</b>. Para recuperar o nome do parceiro de failover real que está em uso no momento, use a seguinte instrução Transact-SQL:</p><div class="sampleCode"><span codeLanguage="other"><pre>SELECT m.mirroring_role_DESC, m.mirroring_state_DESC,
m.mirroring_partner_instance FROM sys.databases as db,
sys.database_mirroring AS m WHERE db.name = 'MirroringDBName'
AND db.database_id = m.database_id</pre></span></div><div style="margin: .5em 1.5em .5em 1.5em"><b></b><p>Você precisará alterar essa instrução para usar o nome do seu banco de dados de espelhamento.</p></div><p>Considere o armazenamento em cache das informações do parceiro para atualizar a cadeia de conexão ou crie uma estratégia de repetição em caso de falha da primeira tentativa de estabelecer uma conexão.</p></div><h1 class="heading">Exemplo</h1><div id="sectionSection1" class="section" name="collapseableSection" style=""><p>No exemplo a seguir, primeiro é feita uma tentativa de conectar ao servidor principal. Se isso falhar e uma exceção for lançada, será feita uma tentativa de conectar ao servidor espelho, que pode ter sido elevado a novo servidor principal. Observe o uso da propriedade failoverPartner na cadeia de conexão.</p><div class="sampleCode"><span codeLanguage="other"><pre>import java.sql.*;

public class clientFailover {

   public static void main(String[] args) {

      // Create a variable for the connection string.
      String connectionUrl = "jdbc:sqlserver://serverA:1433;" +
         "databaseName=AdventureWorks;integratedSecurity=true;" +
         "failoverPartner=serverB";

      // Declare the JDBC objects.
      Connection con = null;
      Statement stmt = null;

      try {
         // Establish the connection to the principal server.
         Class.forName("com.microsoft.sqlserver.jdbc.SQLServerDriver");
         con = DriverManager.getConnection(connectionUrl);
         System.out.println("Connected to the principal server.");

         // Note that if a failover of serverA occurs here, then an
         // exception will be thrown and the failover partner will
         // be used in the first catch block below.

         // Create and execute an SQL statement that inserts some data.
         stmt = con.createStatement();

         // Note that the following statement assumes that the 
         // TestTable table has been created in the AdventureWorks
         // sample database.
         stmt.executeUpdate("INSERT INTO TestTable (Col2, Col3) VALUES ('a', 10)");
      }

      // Handle any errors that may have occurred.
      catch (SQLException se) {
         try {
            // The connection to the principal server failed,
            // try the mirror server which may now be the new
            // principal server.
            System.out.println("Connection to principal server failed, " +
            "trying the mirror server.");
            con = DriverManager.getConnection(connectionUrl);
            System.out.println("Connected to the new principal server.");
            stmt = con.createStatement();
            stmt.executeUpdate("INSERT INTO TestTable (Col2, Col3) VALUES ('a', 10)");
         }
         catch (Exception e) {
            e.printStackTrace();
         }
      }
      catch (Exception e) {
         e.printStackTrace();
      }
      // Close the JDBC objects.
      finally {
         if (stmt != null) try { stmt.close(); } catch(Exception e) {}
         if (con != null) try { con.close(); } catch(Exception e) {}
      }
   }
}</pre></span></div></div><span id="seeAlsoSpan"><h1 class="heading">Consulte também</h1></span><div id="seeAlsoSection" class="section" name="collapseableSection" style=""><div class="seeAlsoStyle"><span sdata="link"><a href="94bcfbe3-f00e-4774-bda8-bb7577518fec.htm">Conectando ao SQL Server com o JDBC Driver</a></span></div></div></div><div id="footer" class="section"><span id="feedbackarea">Envie <a href="javascript:SubmitFeedback('DevDocs@Microsoft.com','','','','8.0.12060.10000','%0\dObrigado%20por%20seus%20comentários.%20As%20equipes%20de%20desenvolvimento%20usam%20seus%20comentários%20para%20melhorar%20a%20documentação.%20Enquanto%20estivermos%20examinando%20seus%20comentários%20,%20poderemos%20enviar%20um%20email%20solicitando%20mais%20esclarecimentos%20ou%20comentários%20sobre%20a%20solução%20encontrada%20.%20Não%20usaremos%20seu%20endereço%20de%20email%20para%20nenhum%20outro%20propósito%20e%20o%20excluiremos%20após%20concluirmos%20a%20análise.%0\APara%20obter%20informações%20sobre%20a%20política%20de%20privacidade%20da%20Microsoft,%20consulte%20http://privacy.microsoft.com/pt-br/default.aspx.%0\A%0\d','Comentários%20do%20cliente.');">comentários</a> sobre este tópico à Microsoft.</span><span id="copyrightarea"><p><a href="9bad553b-9e70-4696-8499-2e35f772a1e0.htm">© 2012 Microsoft. Todos os direitos reservados.</a></p></span></div></div></body></html>